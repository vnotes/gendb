// Code generated by gendb; DO NOT EDIT.
package model

import (
	"context"
	"database/sql"
	"fmt"
	"strings"
	"time"

	"github.com/jmoiron/sqlx"	
)

{{$upperCamelCase := snakeCase2UpperCamelCase $.TableName}}
{{$lowerCamelCase := snakeCase2LowerCamelCase $.TableName}}
{{$receiverName := receiverName $.TableName}}

const(
    {{$upperCamelCase}}Table = "{{.TableName}}"
)

type {{$lowerCamelCase}}Column struct {
	{{range $key, $value := .Columns -}}
		{{snakeCase2UpperCamelCase $value.ColumnName}} string
	{{end -}}
}

var (
	{{$upperCamelCase}}Col = &{{$lowerCamelCase}}Column{
		{{range $key, $value := .Columns -}}
			{{snakeCase2UpperCamelCase $value.ColumnName}}: "{{$value.ColumnName}}",
        {{end -}}
    }
)

type {{$upperCamelCase}}Entity struct {
	{{range $key, $value := .Columns -}}
			{{if $value.ColumnComment}}
				{{snakeCase2UpperCamelCase $value.ColumnName}} {{$value.DataType}} `db:"{{$value.ColumnName}}"` // {{$value.ColumnComment}}
			{{else}}
				{{snakeCase2UpperCamelCase $value.ColumnName}} {{$value.DataType}} `db:"{{$value.ColumnName}}"`
			{{end}}
	{{end -}}
}

type {{$upperCamelCase}}Model interface {
	Insert(context.Context, ...map[string]interface{}) (sql.Result, error)
	Select(context.Context, map[string]interface{}, ...string) ([]*{{$upperCamelCase}}Entity, error)
}

var (
	{{$receiverName}} *{{$lowerCamelCase}}Impl
)

type {{$lowerCamelCase}}Impl struct {
	db sqlx.ExtContext
}

func Set{{$upperCamelCase}}Cli(db sqlx.ExtContext) {
	{{$receiverName}} = &{{$lowerCamelCase}}Impl{db: db}
}

func Get{{$upperCamelCase}}Cli() {{$upperCamelCase}}Model {
	return {{$receiverName}}
}

var _ {{$upperCamelCase}}Model = (*{{$lowerCamelCase}}Impl)(nil)

func ({{$receiverName}} *{{$lowerCamelCase}}Impl) Insert(ctx context.Context, values ...map[string]interface{}) (sql.Result, error) {
	if len(values) == 0 {
		return nil, nil
	}
	var fields []string
	for k := range values[0] {
		fields = append(fields, k)
	}
	k := strings.Join(fields, ",")
	v := ":" + strings.Join(fields, ",:")
	s := fmt.Sprintf("INSERT INTO {{.TableName}} (%s) VALUES (%s);", k, v)
	result, err := sqlx.NamedExecContext(ctx, {{$receiverName}}.db, s, values)
	if err != nil {
		return nil, fmt.Errorf("insert error %w", err)
	}
	return result, nil
}

func ({{$receiverName}} *{{$lowerCamelCase}}Impl) Select(ctx context.Context, values map[string]interface{}, fields ...string) ([]*{{$upperCamelCase}}Entity, error) {
	var result []*{{$upperCamelCase}}Entity

	var s []string
	var args []interface{}
	for k, v := range values {
		s = append(s, fmt.Sprintf("%s=?", k))
		args = append(args, v)
	}
	var query = fmt.Sprintf("SELECT %s FROM {{.TableName}} WHERE %s", strings.Join(fields, ","), strings.Join(s, " and "))
	err := sqlx.SelectContext(ctx, {{$receiverName}}.db, &result, query, args...)
	if err != nil {
		return nil, fmt.Errorf("select error %w", err)
	}
	return result, nil
}